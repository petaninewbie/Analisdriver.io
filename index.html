<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penunjang Driver Ojol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN untuk visualisasi grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc, Timestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('Debug'); // Mengaktifkan logging debug untuk Firebase

        // --- Konfigurasi Global ---
        let db, auth;
        let userId = 'guest';
        let isAuthReady = false;
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- State Aplikasi & Chart Instances ---
        let allOrders = []; 
        let checklistItems = [];
        let allExpenses = []; 
        let todayOrders = []; 
        let todayExpenses = []; 

        let serviceChartInstance = null;
        let dayChartInstance = null;
        let hourChartInstance = null;


        // --- UTILITY FUNCTIONS ---
        const formatRupiah = (num) => `Rp ${num.toLocaleString('id-ID')}`;

        function alertCustom(message) {
            const modal = document.getElementById('custom-alert-modal');
            const messageEl = document.getElementById('custom-alert-message');
            messageEl.textContent = message;
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
            setTimeout(() => {
                modal.classList.remove('opacity-100');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 500);
            }, 3000);
        }

        // --- FIREBASE INITIALIZATION & AUTH ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        userId = 'anon_' + crypto.randomUUID(); 
                    }

                    document.getElementById('user-id-display').textContent = `ID Anda: ${userId}`;
                    
                    if (!isAuthReady) {
                        isAuthReady = true;
                        startListeners();
                        updateZoneRecommendation();
                        setInterval(updateZoneRecommendation, 60000); 
                    }
                });
                
                if (INITIAL_AUTH_TOKEN) {
                    await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Kesalahan saat inisialisasi Firebase atau Otentikasi:", error);
                document.getElementById('status-message').textContent = '‚ö†Ô∏è Gagal terhubung ke database. Cek konsol.';
            }
        });
        
        // --- DATA LISTENERS ---
        function startListeners() {
            const todayDateString = new Date().toDateString();

            // 1. Order Log Listener
            const ordersPath = `artifacts/${APP_ID}/users/${userId}/driver_log`;
            const ordersQuery = query(collection(db, ordersPath), where("userId", "==", userId));
            onSnapshot(ordersQuery, (snapshot) => {
                const fetchedOrders = [];
                snapshot.forEach(doc => {
                    fetchedOrders.push({ id: doc.id, ...doc.data() });
                });
                allOrders = fetchedOrders.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                todayOrders = allOrders.filter(order => order.timestamp.toDate().toDateString() === todayDateString);
                
                renderOrderLog();
                renderSummary(); 
                analyzeOrders(); 
            }, (error) => {
                console.error("Error fetching orders:", error);
            });

            // 2. Expense Log Listener (Pengeluaran)
            const expensesPath = `artifacts/${APP_ID}/users/${userId}/driver_expenses`;
            const expensesQuery = query(collection(db, expensesPath), where("userId", "==", userId));
            onSnapshot(expensesQuery, (snapshot) => {
                const fetchedExpenses = [];
                snapshot.forEach(doc => {
                    fetchedExpenses.push({ id: doc.id, ...doc.data() });
                });
                allExpenses = fetchedExpenses.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                todayExpenses = allExpenses.filter(expense => expense.timestamp.toDate().toDateString() === todayDateString);

                renderExpenseLog();
                renderSummary(); 
            }, (error) => {
                console.error("Error fetching expenses:", error);
            });

            // 3. Checklist Listener (Unchanged)
            const checklistPath = `artifacts/${APP_ID}/users/${userId}/driver_checklist`;
            const checklistQuery = query(collection(db, checklistPath), where("userId", "==", userId));
            onSnapshot(checklistQuery, (snapshot) => {
                const fetchedItems = [];
                snapshot.forEach(doc => {
                    fetchedItems.push({ id: doc.id, ...doc.data() });
                });
                checklistItems = fetchedItems.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                renderChecklist();
            }, (error) => {
                console.error("Error fetching checklist:", error);
            });
        }

        // --- ZONA RAMAI (REKOMENDASI) & SUMMARY (Unchanged) ---
        function getOptimalZone() {
             const now = new Date();
            const hour = now.getHours();
            const day = now.getDay(); 
            let title, message, color;

            if (day >= 1 && day <= 5) { 
                if (hour >= 6 && hour < 9) {
                    title = "Pagi Komuter";
                    message = "Fokus di **Area Perumahan padat** menuju kawasan perkantoran/sekolah. Orderan *Bike* dan *Express* diprediksi ramai.";
                    color = "bg-green-100 text-green-800";
                } else if (hour >= 11 && hour < 14) {
                    title = "Jam Makan Siang Puncak";
                    message = "Bersiap di sekitar **Pusat Bisnis/Mall** atau sentra kuliner. Orderan *Food* mendominasi.";
                    color = "bg-yellow-100 text-yellow-800";
                } else if (hour >= 16 && hour < 19) {
                    title = "Sore Pulang Kerja";
                    message = "Kembali ke **Kawasan Perkantoran/Pusat Kota**. Orderan pulang kerja dan jam-jam sibuk memuncak.";
                    color = "bg-red-100 text-red-800";
                } else {
                    title = "Waktu Normal";
                    message = "Coba di sekitar **Mal atau Pusat Transportasi**. Orderan cenderung stabil.";
                    color = "bg-gray-100 text-gray-800";
                }
            } else { // Akhir Pekan
                if (hour >= 10 && hour < 18) {
                    title = "Siang Rekreasi";
                    message = "Fokus di **Pusat Perbelanjaan, Destinasi Wisata, atau Area Kuliner**. Permintaan keluarga tinggi.";
                    color = "bg-blue-100 text-blue-800";
                } else if (hour >= 18 && hour < 22) {
                    title = "Malam Hiburan";
                    message = "Tetap di **Area Kuliner/Hiburan Malam**. Permintaan *Food* dan perjalanan malam tinggi.";
                    color = "bg-red-100 text-red-800";
                } else {
                    title = "Waktu Tenang";
                    message = "Prioritaskan istirahat. Jika ingin jalan, fokus pada area yang buka 24 jam.";
                    color = "bg-gray-100 text-gray-800";
                }
            }

            return { title, message, color, time: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) };
        }

        function updateZoneRecommendation() {
            const zone = getOptimalZone();
            const container = document.getElementById('zone-recommendation');
            if (container) {
                container.innerHTML = `
                    <div class="p-4 rounded-xl shadow-lg ${zone.color} transition duration-300">
                        <p class="text-sm font-semibold mb-1">Rekomendasi saat ini (${zone.time})</p>
                        <h3 class="text-lg font-bold">${zone.title}</h3>
                        <p class="mt-2 text-sm">${zone.message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                    </div>
                `;
            }
        }
        
        function renderSummary() {
            const summary = document.getElementById('daily-summary');
            const totalEarning = todayOrders.reduce((sum, order) => sum + order.earning, 0);
            const totalExpense = todayExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = totalEarning - totalExpense;

            summary.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <p class="text-sm font-medium">Total Pendapatan (Bruto):</p>
                    <p class="text-xl font-extrabold text-lime-100">${formatRupiah(totalEarning)}</p>
                </div>
                <div class="flex justify-between items-center mb-3 border-b border-lime-500 pb-3">
                    <p class="text-sm font-medium">Total Pengeluaran Hari Ini:</p>
                    <p class="text-xl font-extrabold text-red-300">- ${formatRupiah(totalExpense)}</p>
                </div>
                <div class="flex justify-between items-center">
                    <p class="text-lg font-medium">Keuntungan Bersih:</p>
                    <p class="text-3xl font-extrabold ${netProfit >= 0 ? 'text-white' : 'text-red-300'}">${formatRupiah(netProfit)}</p>
                </div>
            `;
        }

        // --- LOG ORDER & EXPENSE (CRUD & Render, Unchanged) ---
        // (Function implementations for addOrder, deleteOrder, renderOrderLog, 
        // addExpense, deleteExpense, renderExpenseLog are omitted for brevity, 
        // as they remain the same as the previous iteration, but are present in the final file.)
        
        async function addOrder(event) {
            event.preventDefault();
            if (!isAuthReady) return;

            const form = event.target;
            const serviceType = form.serviceType.value;
            const earning = parseFloat(form.earning.value);

            if (isNaN(earning) || earning <= 0) {
                alertCustom("Pendapatan harus angka positif.");
                return;
            }

            try {
                const ordersPath = `artifacts/${APP_ID}/users/${userId}/driver_log`;
                await addDoc(collection(db, ordersPath), {
                    serviceType,
                    earning,
                    timestamp: Timestamp.now(),
                    userId: userId 
                });
                form.reset();
                alertCustom("Order berhasil dicatat!");
            } catch (e) {
                console.error("Error adding document: ", e);
                alertCustom("Gagal mencatat order.");
            }
        }

        async function deleteOrder(id) {
            if (!isAuthReady) return;
            try {
                const ordersPath = `artifacts/${APP_ID}/users/${userId}/driver_log`;
                await deleteDoc(doc(db, ordersPath, id));
                alertCustom("Order berhasil dihapus.");
            } catch (e) {
                console.error("Error deleting document: ", e);
                alertCustom("Gagal menghapus order.");
            }
        }

        function renderOrderLog() {
            const container = document.getElementById('orders-list');
            container.innerHTML = '';

            if (todayOrders.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada order dicatat hari ini.</p>';
            } else {
                todayOrders.forEach(order => {
                    const item = document.createElement('div');
                    const date = order.timestamp.toDate();
                    const timeString = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                    item.className = 'flex justify-between items-center p-3 bg-white rounded-xl shadow-sm border-l-4 border-lime-500 mb-2';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${order.serviceType}</p>
                            <p class="text-xs text-gray-500">${timeString}</p>
                        </div>
                        <div class="flex items-center">
                            <p class="font-bold text-lg text-lime-600 mr-4">${formatRupiah(order.earning)}</p>
                            <button onclick="deleteOrder('${order.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
        }

        async function addExpense(event) {
            event.preventDefault();
            if (!isAuthReady) return;

            const form = event.target;
            const expenseType = form.expenseType.value;
            const amount = parseFloat(form.amount.value);
            const notes = form.notes.value.trim();

            if (isNaN(amount) || amount <= 0) {
                alertCustom("Jumlah pengeluaran harus angka positif.");
                return;
            }

            try {
                const expensesPath = `artifacts/${APP_ID}/users/${userId}/driver_expenses`;
                await addDoc(collection(db, expensesPath), {
                    type: expenseType,
                    amount: amount,
                    notes: notes,
                    timestamp: Timestamp.now(),
                    userId: userId 
                });
                form.reset();
                alertCustom("Pengeluaran berhasil dicatat!");
            } catch (e) {
                console.error("Error adding expense: ", e);
                alertCustom("Gagal mencatat pengeluaran.");
            }
        }

        async function deleteExpense(id) {
            if (!isAuthReady) return;
            try {
                const expensesPath = `artifacts/${APP_ID}/users/${userId}/driver_expenses`;
                await deleteDoc(doc(db, expensesPath, id));
                alertCustom("Pengeluaran berhasil dihapus.");
            } catch (e) {
                console.error("Error deleting expense: ", e);
                alertCustom("Gagal menghapus pengeluaran.");
            }
        }

        function renderExpenseLog() {
            const container = document.getElementById('expenses-list');
            container.innerHTML = '';

            if (todayExpenses.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada pengeluaran dicatat hari ini.</p>';
            } else {
                todayExpenses.forEach(expense => {
                    const item = document.createElement('div');
                    const date = expense.timestamp.toDate();
                    const timeString = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                    item.className = 'flex justify-between items-center p-3 bg-white rounded-xl shadow-sm border-l-4 border-red-500 mb-2';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${expense.type}</p>
                            <p class="text-xs text-gray-500">${timeString} - ${expense.notes || 'Tidak ada catatan'}</p>
                        </div>
                        <div class="flex items-center">
                            <p class="font-bold text-lg text-red-600 mr-4">${formatRupiah(expense.amount)}</p>
                            <button onclick="deleteExpense('${expense.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
        }


        // --- DIAGNOSTIK / ANALISIS DATA (Menganalisis ALL ORDERS) ---
        function analyzeOrders() {
            const totalOverallEarning = allOrders.reduce((sum, order) => sum + order.earning, 0);
            
            const results = {
                byService: {},
                byDay: { 'Minggu': 0, 'Senin': 0, 'Selasa': 0, 'Rabu': 0, 'Kamis': 0, 'Jumat': 0, 'Sabtu': 0 },
                byHour: {}
            };
            const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

            if (totalOverallEarning === 0) {
                renderAnalysisResults(results, totalOverallEarning);
                return;
            }

            allOrders.forEach(order => {
                const date = order.timestamp.toDate();
                const day = dayNames[date.getDay()];
                const hour = date.getHours();
                const earning = order.earning;
                const service = order.serviceType;
                
                if (!results.byService[service]) {
                    results.byService[service] = { total: 0, count: 0 };
                }
                results.byService[service].total += earning;
                results.byService[service].count += 1;

                results.byDay[day] += earning;

                if (!results.byHour[hour]) {
                    results.byHour[hour] = { total: 0, count: 0 };
                }
                results.byHour[hour].total += earning;
                results.byHour[hour].count += 1;
            });

            renderAnalysisResults(results, totalOverallEarning);
        }

        function renderAnalysisResults(results, totalOverallEarning) {
            const serviceContainer = document.getElementById('analysis-by-service');
            const dayContainer = document.getElementById('analysis-by-day');
            const hourContainer = document.getElementById('analysis-by-hour');
            
            // Render Layanan (Table View)
            let serviceHtml = '';
            const services = Object.entries(results.byService).sort(([,a], [,b]) => b.total - a.total);
            services.forEach(([service, data]) => {
                const percentage = (data.total / totalOverallEarning * 100).toFixed(1);
                serviceHtml += `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${service}</span>
                            <span class="text-lime-600 font-bold">${formatRupiah(data.total)}</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>${data.count} Order</span>
                            <span class="text-orange-500">${percentage}% dari Total</span>
                        </div>
                    </div>`;
            });
            serviceContainer.innerHTML = serviceHtml || '<p class="text-gray-500">Tidak ada data layanan untuk dianalisis.</p>';

            // Render Hari (Table View)
            let dayHtml = '';
            const days = Object.entries(results.byDay).sort(([,a], [,b]) => b - a);
            days.forEach(([day, total]) => {
                const percentage = (total / totalOverallEarning * 100).toFixed(1);
                dayHtml += `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${day}</span>
                            <span class="text-lime-600 font-bold">${formatRupiah(total)}</span>
                        </div>
                        <div class="text-xs text-right text-orange-500 mt-1">
                            ${percentage}% dari Total
                        </div>
                    </div>`;
            });
            dayContainer.innerHTML = dayHtml || '<p class="text-gray-500">Tidak ada data hari untuk dianalisis.</p>';
            
            // Render Jam (Table View)
            let hourHtml = '';
            const hours = Object.entries(results.byHour).sort(([a,], [b,]) => parseInt(a) - parseInt(b)); 
            hours.forEach(([hour, data]) => {
                const hourDisplay = `${hour.padStart(2, '0')}:00 - ${String(parseInt(hour) + 1).padStart(2, '0')}:00`;
                const percentage = (data.total / totalOverallEarning * 100).toFixed(1);
                hourHtml += `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${hourDisplay}</span>
                            <span class="text-lime-600 font-bold">${formatRupiah(data.total)}</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>${data.count} Order</span>
                            <span class="text-orange-500">${percentage}% dari Total</span>
                        </div>
                    </div>`;
            });
            hourContainer.innerHTML = hourHtml || '<p class="text-gray-500">Tidak ada data jam untuk dianalisis.</p>';
            
            if (allOrders.length === 0) {
                 document.getElementById('analysis-message').innerHTML = '<p class="text-center text-red-500 py-4 font-semibold">Catat Order di Tab Log Order untuk memulai analisis!</p>';
            } else {
                 document.getElementById('analysis-message').innerHTML = `<p class="text-center text-sm text-gray-500 italic">Data dianalisis dari total ${allOrders.length} order (Total Pendapatan Bruto: ${formatRupiah(totalOverallEarning)})</p>`;
            }
            
            // --- Render Charts ---
            renderServiceChart(services);
            renderDayChart(results.byDay);
            renderHourChart(hours);
        }

        // --- CHART RENDERING FUNCTIONS ---
        const colors = [
            '#65a30d', '#a3e635', '#fcd34d', '#f87171', '#38bdf8', '#fb7185', '#a78bfa'
        ];
        
        // 1. Chart Layanan (Doughnut)
        function renderServiceChart(services) {
            if (serviceChartInstance) serviceChartInstance.destroy();
            
            const labels = services.map(([service,]) => service);
            const data = services.map(([, data]) => data.total);
            
            serviceChartInstance = new Chart(document.getElementById('serviceChart'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pendapatan (Rp)',
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });
        }

        // 2. Chart Hari (Bar)
        function renderDayChart(daysData) {
            if (dayChartInstance) dayChartInstance.destroy();

            const dayNamesOrder = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
            const sortedLabels = dayNamesOrder;
            const sortedData = dayNamesOrder.map(day => daysData[day]);
            
            dayChartInstance = new Chart(document.getElementById('dayChart'), {
                type: 'bar',
                data: {
                    labels: sortedLabels,
                    datasets: [{
                        label: 'Pendapatan',
                        data: sortedData,
                        backgroundColor: '#65a30d', // lime-600
                        borderColor: '#4d7c0f',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Pendapatan (Rp)' } },
                        x: { title: { display: true, text: 'Hari' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${formatRupiah(context.parsed.y)}` } }
                    }
                }
            });
        }

        // 3. Chart Jam (Bar)
        function renderHourChart(hours) {
            if (hourChartInstance) hourChartInstance.destroy();

            const labels = hours.map(([hour,]) => `${hour.padStart(2, '0')}:00`);
            const data = hours.map(([, data]) => data.total);
            
            hourChartInstance = new Chart(document.getElementById('hourChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pendapatan',
                        data: data,
                        backgroundColor: '#fcd34d', // amber-300
                        borderColor: '#f59e0b',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Pendapatan (Rp)' } },
                        x: { title: { display: true, text: 'Jam' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${formatRupiah(context.parsed.y)}` } }
                    }
                }
            });
        }

        // --- CHECKLIST (CRUD) ---
        async function addChecklistItem(event) {
            event.preventDefault();
            if (!isAuthReady) return;

            const form = event.target;
            const text = form.checklistItemText.value.trim();

            if (!text) return;

            try {
                const checklistPath = `artifacts/${APP_ID}/users/${userId}/driver_checklist`;
                await addDoc(collection(db, checklistPath), {
                    text,
                    completed: false,
                    createdAt: Timestamp.now(),
                    userId: userId
                });
                form.reset();
                alertCustom("Item checklist berhasil ditambahkan.");
            } catch (e) {
                console.error("Error adding checklist item: ", e);
                alertCustom("Gagal menambahkan item.");
            }
        }

        async function toggleChecklistItem(id, completed) {
            if (!isAuthReady) return;
            try {
                const checklistPath = `artifacts/${APP_ID}/users/${userId}/driver_checklist`;
                await updateDoc(doc(db, checklistPath, id), {
                    completed: !completed
                });
            } catch (e) {
                console.error("Error toggling checklist item: ", e);
                alertCustom("Gagal memperbarui status.");
            }
        }

        async function deleteChecklistItem(id) {
            if (!isAuthReady) return;
            try {
                const checklistPath = `artifacts/${APP_ID}/users/${userId}/driver_checklist`;
                await deleteDoc(doc(db, checklistPath, id));
                alertCustom("Item checklist berhasil dihapus.");
            } catch (e) {
                console.error("Error deleting checklist item: ", e);
                alertCustom("Gagal menghapus item.");
            }
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-items');
            container.innerHTML = '';

            if (checklistItems.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-2">Tambahkan tugas harian Anda, seperti cek bensin atau ban.</p>';
            } else {
                checklistItems.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = `flex items-center justify-between p-3 bg-white rounded-xl shadow-sm mb-2 transition duration-200 ${item.completed ? 'opacity-70' : 'hover:bg-gray-50'}`;
                    
                    const textClass = item.completed ? 'line-through text-gray-500' : 'text-gray-800';

                    listItem.innerHTML = `
                        <div class="flex items-center flex-grow">
                            <input type="checkbox" id="check-${item.id}" ${item.completed ? 'checked' : ''} 
                                onclick="toggleChecklistItem('${item.id}', ${item.completed})" 
                                class="w-5 h-5 text-lime-600 bg-gray-100 border-gray-300 rounded focus:ring-lime-500 focus:border-lime-500 transition duration-150 cursor-pointer">
                            <label for="check-${item.id}" class="ml-3 text-sm font-medium ${textClass} cursor-pointer">${item.text}</label>
                        </div>
                        <button onclick="deleteChecklistItem('${item.id}')" class="text-red-400 hover:text-red-600 p-1 rounded-full transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    container.appendChild(listItem);
                });
            }
        }

        // --- GLOBAL WINDOW EXPOSURE ---
        window.addOrder = addOrder;
        window.deleteOrder = deleteOrder;
        window.addExpense = addExpense;
        window.deleteExpense = deleteExpense;
        window.addChecklistItem = addChecklistItem;
        window.toggleChecklistItem = toggleChecklistItem;
        window.deleteChecklistItem = deleteChecklistItem;
        
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .tab-button {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom: 3px solid #65a30d; /* lime-600 */
            color: #65a30d;
            font-weight: 700;
        }
        /* Memastikan canvas di dalam kontainer yang responsif */
        canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body class="p-4 sm:p-6 pb-20">
    <div id="status-message" class="text-center text-sm text-gray-500 mb-2">Memuat data...</div>
    <div id="user-id-display" class="text-center text-xs text-gray-400 mb-4 truncate" title="ID unik untuk menyimpan data Anda"></div>

    <header class="mb-6">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-1">Driver Boost</h1>
        <p class="text-gray-500">Optimalkan Order, Minimalisir Pengeluaran!</p>
    </header>

    <!-- Tab Navigation -->
    <div class="flex justify-around bg-white p-2 rounded-xl shadow-md mb-6 sticky top-0 z-10 border-b border-gray-100 overflow-x-auto">
        <button id="tab-zona" class="tab-button active p-3 flex-1 min-w-[100px] text-center text-gray-600" onclick="switchTab('zona')">Zona Ramai</button>
        <button id="tab-log" class="tab-button p-3 flex-1 min-w-[100px] text-center text-gray-600" onclick="switchTab('log')">Log Order</button>
        <button id="tab-pengeluaran" class="tab-button p-3 flex-1 min-w-[100px] text-center text-gray-600" onclick="switchTab('pengeluaran')">Pengeluaran</button>
        <button id="tab-diagnostik" class="tab-button p-3 flex-1 min-w-[100px] text-center text-gray-600" onclick="switchTab('diagnostik')">Diagnostik</button>
        <button id="tab-checklist" class="tab-button p-3 flex-1 min-w-[100px] text-center text-gray-600" onclick="switchTab('checklist')">Checklist</button>
    </div>

    <!-- Tab Content Container -->
    <div id="tab-content">
        
        <!-- Tab 1: Zona Ramai -->
        <div id="content-zona" class="tab-content">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Pola Permintaan Harian</h2>
            <div id="zone-recommendation" class="mb-6">
                <!-- Konten rekomendasi akan dimuat di sini -->
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md">
                <p class="text-sm text-gray-600 italic">Tips: Gunakan rekomendasi ini sebagai panduan awal, tapi selalu utamakan Peta Panas di aplikasi resmi Anda.</p>
            </div>
        </div>

        <!-- Tab 2: Log Order -->
        <div id="content-log" class="tab-content hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Catat Penghasilan Harian</h2>

            <!-- Ringkasan Pendapatan -->
            <div id="daily-summary" class="bg-lime-600 text-white p-5 rounded-xl shadow-xl mb-6 text-center">
                <!-- Ringkasan Keuntungan Bersih akan di-render di sini -->
            </div>

            <!-- Form Tambah Order -->
            <form id="add-order-form" onsubmit="addOrder(event)" class="bg-white p-5 rounded-xl shadow-md mb-6 space-y-4">
                <h3 class="font-semibold text-gray-800">Tambah Order Baru</h3>
                <div>
                    <label for="serviceType" class="block text-sm font-medium text-gray-700 mb-1">Jenis Layanan</label>
                    <select id="serviceType" name="serviceType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-lime-500 focus:border-lime-500">
                        <option value="GrabBike">GrabBike</option>
                        <option value="GrabFood">GrabFood</option>
                        <option value="GrabExpress">GrabExpress</option>
                        <option value="GrabCar">GrabCar</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div>
                    <label for="earning" class="block text-sm font-medium text-gray-700 mb-1">Pendapatan (Netto, Rp)</label>
                    <input type="number" id="earning" name="earning" required min="1" placeholder="Contoh: 15000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-lime-500 focus:border-lime-500">
                </div>
                <button type="submit" class="w-full bg-lime-600 text-white p-3 rounded-xl font-bold hover:bg-lime-700 transition duration-200 shadow-md shadow-lime-300">
                    Catat Order Selesai
                </button>
            </form>

            <!-- Daftar Order -->
            <h3 class="text-lg font-bold text-gray-800 mb-3">Riwayat Order Hari Ini (Terbaru)</h3>
            <div id="orders-list">
                <!-- Daftar order akan di-render di sini -->
            </div>
        </div>
        
        <!-- Tab 3: Pengeluaran -->
        <div id="content-pengeluaran" class="tab-content hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Catat Pengeluaran Harian</h2>

            <!-- Form Tambah Pengeluaran -->
            <form id="add-expense-form" onsubmit="addExpense(event)" class="bg-white p-5 rounded-xl shadow-md mb-6 space-y-4">
                <h3 class="font-semibold text-gray-800">Tambah Pengeluaran Baru</h3>
                <div>
                    <label for="expenseType" class="block text-sm font-medium text-gray-700 mb-1">Jenis Pengeluaran</label>
                    <select id="expenseType" name="expenseType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                        <option value="Bensin">Bensin ‚õΩÔ∏è</option>
                        <option value="Makan/Minum">Makan/Minum üçî</option>
                        <option value="Pulsa/Data">Pulsa/Data üì∂</option>
                        <option value="Parkir/Tol">Parkir/Tol üÖøÔ∏è</option>
                        <option value="Perbaikan Motor">Perbaikan Motor üõ†Ô∏è</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Pengeluaran (Rp)</label>
                    <input type="number" id="amount" name="amount" required min="1" placeholder="Contoh: 35000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                </div>
                 <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Catatan (Opsional)</label>
                    <input type="text" id="notes" name="notes" placeholder="Misal: Shell V-Power, makan di warteg" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                </div>
                <button type="submit" class="w-full bg-red-600 text-white p-3 rounded-xl font-bold hover:bg-red-700 transition duration-200 shadow-md shadow-red-300">
                    Catat Pengeluaran
                </button>
            </form>

            <!-- Daftar Pengeluaran -->
            <h3 class="text-lg font-bold text-gray-800 mb-3">Riwayat Pengeluaran Hari Ini (Terbaru)</h3>
            <div id="expenses-list">
                <!-- Daftar pengeluaran akan di-render di sini -->
            </div>
        </div>

        
        <!-- Tab 4: Diagnostik -->
        <div id="content-diagnostik" class="tab-content hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Analisis Kinerja Historis</h2>
            
            <div id="analysis-message" class="mb-4">
                <!-- Pesan status analisis -->
            </div>
            
            <div class="space-y-6">
                
                <!-- Analisis per Layanan (Grafik Donut) -->
                <div class="bg-white p-5 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg text-gray-800 mb-3 border-b pb-2">1. Kontribusi Pendapatan Total per Layanan (Grafik Donut)</h3>
                    <div class="h-64 mb-4">
                        <canvas id="serviceChart"></canvas>
                    </div>
                    <div id="analysis-by-service" class="space-y-2">
                        <!-- Hasil analisis per layanan (Tabel) akan di-render di sini -->
                    </div>
                </div>

                <!-- Analisis per Hari (Grafik Batang) -->
                <div class="bg-white p-5 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg text-gray-800 mb-3 border-b pb-2">2. Pendapatan Total per Hari (Tren Mingguan)</h3>
                    <div class="h-64 mb-4">
                        <canvas id="dayChart"></canvas>
                    </div>
                    <div id="analysis-by-day" class="space-y-2">
                        <!-- Hasil analisis per hari (Tabel) akan di-render di sini -->
                    </div>
                </div>

                <!-- Analisis per Jam (Grafik Batang) -->
                <div class="bg-white p-5 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg text-gray-800 mb-3 border-b pb-2">3. Pendapatan Total per Jam Puncak</h3>
                    <div class="h-64 mb-4">
                        <canvas id="hourChart"></canvas>
                    </div>
                    <div id="analysis-by-hour" class="space-y-2">
                        <!-- Hasil analisis per jam (Tabel) akan di-render di sini -->
                    </div>
                </div>

            </div>
        </div>

        <!-- Tab 5: Checklist -->
        <div id="content-checklist" class="tab-content hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Daftar Periksa Kesiapan Harian</h2>

            <!-- Form Tambah Item Checklist -->
            <form id="add-checklist-form" onsubmit="addChecklistItem(event)" class="bg-white p-5 rounded-xl shadow-md mb-6 space-y-4">
                <h3 class="font-semibold text-gray-800">Tambahkan Tugas Baru</h3>
                <div class="flex space-x-2">
                    <input type="text" id="checklistItemText" name="checklistItemText" required placeholder="Contoh: Isi bensin ‚õΩÔ∏è atau Cek oli" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-lime-500 focus:border-lime-500">
                    <button type="submit" class="p-3 bg-lime-500 text-white rounded-xl hover:bg-lime-600 transition duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                </div>
            </form>

            <!-- Daftar Checklist -->
            <ul id="checklist-items" class="space-y-3">
                <!-- Daftar item akan di-render di sini -->
            </ul>
        </div>

    </div>

    <!-- Custom Alert Modal (Pengganti alert()) -->
    <div id="custom-alert-modal" class="hidden opacity-0 fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl transition duration-500 ease-in-out z-50">
        <span id="custom-alert-message"></span>
    </div>

    <script>
        // Logika Penggantian Tab
        function switchTab(tabId) {
            const contents = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');

            contents.forEach(content => {
                content.classList.add('hidden');
            });
            buttons.forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            // Panggil analisis/render ulang jika pindah ke tab diagnostik/pengeluaran
            if (tabId === 'diagnostik') {
                analyzeOrders();
            } else if (tabId === 'pengeluaran') {
                renderExpenseLog();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            switchTab('zona');
        });
    </script>
</body>
</html>

