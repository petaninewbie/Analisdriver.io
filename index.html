<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penunjang Driver Ojol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import modul Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc, Timestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug'); // Mengaktifkan logging debug untuk Firebase

        // ==============================================================================
        // --- KONFIGURASI FIREBASE & FALLBACK UNTUK DEPLOYMENT MANDIRI ---
        // PENTING: Jika Anda deploy kode ini ke GitHub Pages, Anda harus mengganti 
        // placeholder di DEFAULT_FIREBASE_CONFIG di bawah ini dengan kunci proyek 
        // Firebase Anda sendiri. Jika tidak, aplikasi tidak akan terhubung ke database.
        
        const DEFAULT_FIREBASE_CONFIG = {
            // GANTI INI DENGAN CONFIG ANDA:
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        
        let db, auth;
        let userId = 'guest';
        let isAuthReady = false;
        
        // Mengambil variabel lingkungan dari Canvas (jika ada) atau menggunakan default
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let firebaseConfig = DEFAULT_FIREBASE_CONFIG;
        
        // Jika ada konfigurasi dari lingkungan host (Canvas), kita gunakan itu
        if (typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0) {
            firebaseConfig = JSON.parse(__firebase_config);
        } else if (DEFAULT_FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
            console.error("⚠️ Peringatan: Firebase Config belum diatur. Harap ganti placeholder di `DEFAULT_FIREBASE_CONFIG`.");
        }
        // ==============================================================================

        // --- State Aplikasi ---
        let allOrders = []; 
        let allExpenses = []; 
        let checklistItems = [];
        let todayOrders = []; 
        let todayExpenses = []; 
        let currentReportDate = new Date().toISOString().split('T')[0]; // Default: Hari ini

        // --- UTILITY FUNCTIONS ---
        const formatRupiah = (num) => {
            // Memastikan num adalah angka dan memformat ke Rupiah
            if (typeof num !== 'number' || isNaN(num)) return 'Rp 0';
            return `Rp ${num.toLocaleString('id-ID')}`;
        };

        function alertCustom(message) {
            const modal = document.getElementById('custom-alert-modal');
            const messageEl = document.getElementById('custom-alert-message');
            messageEl.textContent = message;
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
            setTimeout(() => {
                modal.classList.remove('opacity-100');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 500);
            }, 3000);
        }

        // --- FIREBASE INITIALIZATION & AUTH ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Set default date for the picker
                const datePicker = document.getElementById('report-date-picker');
                if (datePicker) datePicker.value = currentReportDate;
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        userId = 'anon_' + crypto.randomUUID(); 
                    }

                    document.getElementById('user-id-display').textContent = `ID Anda: ${userId}`;
                    
                    if (!isAuthReady) {
                        isAuthReady = true;
                        startListeners();
                        updateZoneRecommendation();
                        setInterval(updateZoneRecommendation, 60000); 
                    }
                });
                
                // Otentikasi
                if (INITIAL_AUTH_TOKEN) {
                    await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Kesalahan saat inisialisasi Firebase atau Otentikasi:", error);
                document.getElementById('status-message').textContent = '⚠️ Gagal terhubung ke database. Cek konsol.';
            }
        });
        
        // --- DATA LISTENERS ---
        function startListeners() {
            const todayDateString = new Date().toDateString();

            // Fetch data from Firestore
            const fetchAndRender = (snapshot, dataArray, logRenderFn, summaryUpdate = true) => {
                const fetchedData = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.timestamp) {
                        fetchedData.push({ id: doc.id, ...data });
                    }
                });
                
                // Update the global data array
                if (dataArray === 'orders') {
                    allOrders = fetchedData.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                    todayOrders = allOrders.filter(order => order.timestamp.toDate().toDateString() === todayDateString);
                } else if (dataArray === 'expenses') {
                    allExpenses = fetchedData.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                    todayExpenses = allExpenses.filter(expense => expense.timestamp.toDate().toDateString() === todayDateString);
                } else if (dataArray === 'checklist') {
                    checklistItems = fetchedData.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                }

                // Conditional rendering
                if (logRenderFn) logRenderFn();
                if (summaryUpdate) renderSummary(); 
                if (document.getElementById('content-laporan').classList.contains('hidden') === false) {
                    renderDailyReportView(currentReportDate);
                }
            };

            // 1. Order Log Listener
            const ordersPath = `artifacts/${APP_ID}/users/${userId}/driver_log`;
            const ordersQuery = query(collection(db, ordersPath), where("userId", "==", userId));
            onSnapshot(ordersQuery, (snapshot) => fetchAndRender(snapshot, 'orders', renderOrderLog), 
                (error) => console.error("Error fetching orders:", error)
            );

            // 2. Expense Log Listener
            const expensesPath = `artifacts/${APP_ID}/users/${userId}/driver_expenses`;
            const expensesQuery = query(collection(db, expensesPath), where("userId", "==", userId));
            onSnapshot(expensesQuery, (snapshot) => fetchAndRender(snapshot, 'expenses', renderExpenseLog), 
                (error) => console.error("Error fetching expenses:", error)
            );

            // 3. Checklist Listener
            const checklistPath = `artifacts/${APP_ID}/users/${userId}/driver_checklist`;
            const checklistQuery = query(collection(db, checklistPath), where("userId", "==", userId));
            onSnapshot(checklistQuery, (snapshot) => fetchAndRender(snapshot, 'checklist', renderChecklist, false), 
                (error) => console.error("Error fetching checklist:", error)
            );
        }

        // --- ZONA RAMAI (REKOMENDASI) & SUMMARY ---
        function getOptimalZone() {
            const now = new Date();
            const hour = now.getHours();
            const day = now.getDay(); // 0 = Minggu, 6 = Sabtu
            let title, message, color;

            if (day >= 1 && day <= 5) { // Hari Kerja
                if (hour >= 6 && hour < 9) {
                    title = "Pagi Komuter";
                    message = "Fokus di **Area Perumahan padat** menuju kawasan perkantoran/sekolah.";
                    color = "bg-green-100 text-green-800 border-green-300";
                } else if (hour >= 11 && hour < 14) {
                    title = "Jam Makan Siang Puncak";
                    message = "Bersiap di sekitar **Pusat Bisnis/Mall** atau sentra kuliner. Orderan *Food* mendominasi.";
                    color = "bg-yellow-100 text-yellow-800 border-yellow-300";
                } else if (hour >= 16 && hour < 19) {
                    title = "Sore Pulang Kerja";
                    message = "Kembali ke **Kawasan Perkantoran/Pusat Kota**. Orderan pulang kerja dan jam-jam sibuk memuncak.";
                    color = "bg-red-100 text-red-800 border-red-300";
                } else {
                    title = "Waktu Normal";
                    message = "Coba di sekitar **Mal atau Pusat Transportasi**. Orderan cenderung stabil.";
                    color = "bg-gray-100 text-gray-800 border-gray-300";
                }
            } else { // Akhir Pekan (Sabtu/Minggu)
                if (hour >= 10 && hour < 18) {
                    title = "Siang Rekreasi";
                    message = "Fokus di **Pusat Perbelanjaan, Destinasi Wisata, atau Area Kuliner**.";
                    color = "bg-blue-100 text-blue-800 border-blue-300";
                } else if (hour >= 18 && hour < 22) {
                    title = "Malam Hiburan";
                    message = "Tetap di **Area Kuliner/Hiburan Malam**.";
                    color = "bg-red-100 text-red-800 border-red-300";
                } else {
                    title = "Waktu Tenang";
                    message = "Prioritaskan istirahat. Fokus di area perumahan jika ada permintaan Food.";
                    color = "bg-gray-100 text-gray-800 border-gray-300";
                }
            }

            return { title, message, color, time: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) };
        }

        function updateZoneRecommendation() {
            const zone = getOptimalZone();
            const container = document.getElementById('zone-recommendation');
            if (container) {
                container.innerHTML = `
                    <div class="p-4 rounded-xl shadow-lg border-2 ${zone.color} transition duration-300">
                        <p class="text-sm font-semibold mb-1">Rekomendasi saat ini (${zone.time})</p>
                        <h3 class="text-lg font-bold">${zone.title}</h3>
                        <p class="mt-2 text-sm">${zone.message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                    </div>
                `;
            }
        }
        
        function renderSummary() {
            const summary = document.getElementById('daily-summary');
            const totalEarning = todayOrders.reduce((sum, order) => sum + order.earning, 0);
            const totalExpense = todayExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = totalEarning - totalExpense;

            summary.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <p class="text-sm font-medium">Total Pendapatan (Bruto):</p>
                    <p class="text-xl font-extrabold text-white">${formatRupiah(totalEarning)}</p>
                </div>
                <div class="flex justify-between items-center mb-3 border-b border-lime-400 pb-3">
                    <p class="text-sm font-medium">Total Pengeluaran Hari Ini:</p>
                    <p class="text-xl font-extrabold text-red-300">- ${formatRupiah(totalExpense)}</p>
                </div>
                <div class="flex justify-between items-center">
                    <p class="text-lg font-medium">Keuntungan Bersih:</p>
                    <p class="text-3xl font-extrabold ${netProfit >= 0 ? 'text-white' : 'text-red-300'}">${formatRupiah(netProfit)}</p>
                </div>
            `;
        }
        
        // --- LOG ORDER CRUD & Render ---
        async function addOrder(event) {
            event.preventDefault();
            if (!isAuthReady) return;

            const form = event.target;
            const serviceType = form.serviceType.value;
            const earning = parseFloat(form.earning.value);

            if (isNaN(earning) || earning <= 0) {
                alertCustom("Pendapatan harus angka positif.");
                return;
            }

            try {
                const ordersPath = `artifacts/${APP_ID}/users/${userId}/driver_log`;
                await addDoc(collection(db, ordersPath), {
                    serviceType,
                    earning,
                    timestamp: Timestamp.now(),
                    userId: userId 
                });
                form.reset();
                alertCustom("Order berhasil dicatat!");
            } catch (e) {
                console.error("Error adding document: ", e);
                alertCustom("Gagal mencatat order.");
            }
        }

        async function deleteOrder(id) {
            if (!isAuthReady) return;
            try {
                const ordersPath = `artifacts/${APP_ID}/users/${userId}/driver_log`;
                await deleteDoc(doc(db, ordersPath, id));
                alertCustom("Order berhasil dihapus.");
            } catch (e) {
                console.error("Error deleting document: ", e);
                alertCustom("Gagal menghapus order.");
            }
        }

        function renderOrderLog() {
            const container = document.getElementById('orders-list');
            container.innerHTML = '';
            
            if (todayOrders.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada order dicatat hari ini.</p>';
            } else {
                todayOrders.forEach(order => {
                    const item = document.createElement('div');
                    const date = order.timestamp.toDate();
                    const timeString = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                    item.className = 'flex justify-between items-center p-3 bg-white rounded-xl shadow-md border-l-4 border-lime-500 mb-2 log-item';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${order.serviceType}</p>
                            <p class="text-xs text-gray-500">${timeString}</p>
                        </div>
                        <div class="flex items-center">
                            <p class="font-bold text-lg text-lime-600 mr-4">${formatRupiah(order.earning)}</p>
                            <button onclick="deleteOrder('${order.id}')" aria-label="Hapus order" class="text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
        }

        // --- LOG EXPENSE CRUD & Render ---
        async function addExpense(event) {
            event.preventDefault();
            if (!isAuthReady) return;

            const form = event.target;
            const expenseType = form.expenseType.value;
            const amount = parseFloat(form.amount.value);
            const notes = form.notes.value.trim();

            if (isNaN(amount) || amount <= 0) {
                alertCustom("Jumlah pengeluaran harus angka positif.");
                return;
            }

            try {
                const expensesPath = `artifacts/${APP_ID}/users/${userId}/driver_expenses`;
                await addDoc(collection(db, expensesPath), {
                    type: expenseType,
                    amount: amount,
                    notes: notes,
                    timestamp: Timestamp.now(),
                    userId: userId 
                });
                form.reset();
                alertCustom("Pengeluaran berhasil dicatat!");
            } catch (e) {
                console.error("Error adding expense: ", e);
                alertCustom("Gagal mencatat pengeluaran.");
            }
        }

        async function deleteExpense(id) {
            if (!isAuthReady) return;
            try {
                const expensesPath = `artifacts/${APP_ID}/users/${userId}/driver_expenses`;
                await deleteDoc(doc(db, expensesPath, id));
                alertCustom("Pengeluaran berhasil dihapus.");
            } catch (e) {
                console.error("Error deleting expense: ", e);
                alertCustom("Gagal menghapus pengeluaran.");
            }
        }

        function renderExpenseLog() {
            const container = document.getElementById('expenses-list');
            container.innerHTML = '';

            if (todayExpenses.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada pengeluaran dicatat hari ini.</p>';
            } else {
                todayExpenses.forEach(expense => {
                    const item = document.createElement('div');
                    const date = expense.timestamp.toDate();
                    const timeString = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                    item.className = 'flex justify-between items-center p-3 bg-white rounded-xl shadow-md border-l-4 border-red-500 mb-2 log-item';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${expense.type}</p>
                            <p class="text-xs text-gray-500 truncate max-w-[150px]">${timeString} - ${expense.notes || 'Tidak ada catatan'}</p>
                        </div>
                        <div class="flex items-center">
                            <p class="font-bold text-lg text-red-600 mr-4">${formatRupiah(expense.amount)}</p>
                            <button onclick="deleteExpense('${expense.id}')" aria-label="Hapus pengeluaran" class="text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
        }

        // --- LAPORAN HARIAN (Report Generation/Print View) ---
        
        function updateReportDate(event) {
            currentReportDate = event.target.value;
            renderDailyReportView(currentReportDate);
        }

        function renderDailyReportView(dateString) {
            const container = document.getElementById('report-content-container');
            
            if (!isAuthReady) {
                 container.innerHTML = `<p class="text-center text-gray-500 py-12">Menunggu otentikasi...</p>`;
                 return;
            }
            
            const reportDate = new Date(dateString);
            const dateKey = reportDate.toDateString();
            
            // Filter data for the selected day
            const reportOrders = allOrders.filter(order => order.timestamp.toDate().toDateString() === dateKey);
            const reportExpenses = allExpenses.filter(expense => expense.timestamp.toDate().toDateString() === dateKey);
            
            const totalEarning = reportOrders.reduce((sum, order) => sum + order.earning, 0);
            const totalExpense = reportExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = totalEarning - totalExpense;

            // Detail Order List HTML
            let ordersHtml = reportOrders.length > 0
                ? reportOrders.map(order => `
                    <li class="flex justify-between py-2 border-b border-gray-100 text-sm">
                        <span class="text-gray-700">${order.timestamp.toDate().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })} - ${order.serviceType}</span>
                        <span class="font-semibold text-lime-700">${formatRupiah(order.earning)}</span>
                    </li>
                  `).join('')
                : '<p class="text-gray-500 italic p-3 text-center">Tidak ada order dicatat.</p>';

            // Detail Expense List HTML
            let expensesHtml = reportExpenses.length > 0
                ? reportExpenses.map(expense => `
                    <li class="flex justify-between py-2 border-b border-gray-100 text-sm">
                        <span class="text-gray-700">${expense.timestamp.toDate().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })} - ${expense.type} (${expense.notes || '-'})</span>
                        <span class="font-semibold text-red-700">${formatRupiah(expense.amount)}</span>
                    </li>
                  `).join('')
                : '<p class="text-gray-500 italic p-3 text-center">Tidak ada pengeluaran dicatat.</p>';

            // Render Laporan
            container.innerHTML = `
                <!-- Print Header (Visible only on print) -->
                <div class="print-only text-center mb-6 pt-4">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-1">Laporan Keuangan Driver Harian</h1>
                    <p class="text-lg text-gray-600">Tanggal: ${reportDate.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                    <hr class="my-4 border-gray-300"/>
                </div>

                <!-- Summary Block -->
                <div class="bg-lime-600 text-white p-6 rounded-xl shadow-2xl mb-6">
                    <h3 class="text-xl font-bold mb-4 border-b border-lime-400 pb-2">Ringkasan Kinerja</h3>
                    <div class="flex justify-between items-center mb-3">
                        <p class="font-medium">Total Pendapatan (Bruto):</p>
                        <p class="text-2xl font-extrabold">${formatRupiah(totalEarning)}</p>
                    </div>
                    <div class="flex justify-between items-center mb-5 pb-5 border-b border-lime-400">
                        <p class="font-medium">Total Pengeluaran:</p>
                        <p class="text-2xl font-extrabold text-red-300">- ${formatRupiah(totalExpense)}</p>
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="text-2xl font-bold">Keuntungan Bersih:</p>
                        <p class="text-4xl font-extrabold ${netProfit >= 0 ? 'text-white' : 'text-red-300'}">${formatRupiah(netProfit)}</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <!-- Detail Orders -->
                    <div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-lime-500">
                        <h3 class="text-lg font-bold text-gray-800 mb-3 pb-2 flex justify-between items-center">
                            <span>Detail Log Order</span>
                            <span class="text-sm font-normal bg-lime-100 text-lime-800 px-2 py-0.5 rounded-full">${reportOrders.length} Order</span>
                        </h3>
                        <ul class="divide-y divide-gray-100 max-h-[40vh] overflow-y-auto">
                            ${ordersHtml}
                        </ul>
                    </div>

                    <!-- Detail Expenses -->
                    <div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-red-500">
                        <h3 class="text-lg font-bold text-gray-800 mb-3 pb-2 flex justify-between items-center">
                            <span>Detail Log Pengeluaran</span>
                            <span class="text-sm font-normal bg-red-100 text-red-800 px-2 py-0.5 rounded-full">${reportExpenses.length} Pengeluaran</span>
                        </h3>
                        <ul class="divide-y divide-gray-100 max-h-[40vh] overflow-y-auto">
                            ${expensesHtml}
                        </ul>
                    </div>
                </div>

                <!-- Print Button (Visible only on screen) -->
                <div class="mt-8 text-center no-print">
                     <button onclick="window.print()" class="w-full max-w-sm bg-blue-600 text-white p-4 rounded-xl font-bold hover:bg-blue-700 transition duration-200 shadow-xl shadow-blue-300 flex items-center justify-center mx-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M5 4v1h10V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm0 8a2 2 0 012-2h6a2 2 0 012 2v5a2 2 0 01-2 2H7a2 2 0 01-2-2v-5z" />
                            <path d="M7 6h6v1H7V6zm0 3h6v1H7V9z" />
                        </svg>
                        Cetak Laporan Harian (Simpan PDF)
                    </button>
                </div>
            `;
        }
        
        // --- CHECKLIST CRUD & Render ---
        async function addChecklistItem(event) {
            event.preventDefault();
            if (!isAuthReady) return;

            const form = event.target;
            const text = form.checklistItemText.value.trim();

            if (!text) return;

            try {
                const checklistPath = `artifacts/${APP_ID}/users/${userId}/driver_checklist`;
                await addDoc(collection(db, checklistPath), {
                    text,
                    completed: false,
                    createdAt: Timestamp.now(),
                    userId: userId
                });
                form.reset();
                alertCustom("Item checklist berhasil ditambahkan.");
            } catch (e) {
                console.error("Error adding checklist item: ", e);
                alertCustom("Gagal menambahkan item.");
            }
        }

        async function toggleChecklistItem(id, completed) {
            if (!isAuthReady) return;
            try {
                const checklistPath = `artifacts/${APP_ID}/users/${userId}/driver_checklist`;
                await updateDoc(doc(db, checklistPath, id), {
                    completed: !completed
                });
            } catch (e) {
                console.error("Error toggling checklist item: ", e);
                alertCustom("Gagal memperbarui status.");
            }
        }

        async function deleteChecklistItem(id) {
            if (!isAuthReady) return;
            try {
                const checklistPath = `artifacts/${APP_ID}/users/${userId}/driver_checklist`;
                await deleteDoc(doc(db, checklistPath, id));
                alertCustom("Item checklist berhasil dihapus.");
            } catch (e) {
                console.error("Error deleting checklist item: ", e);
                alertCustom("Gagal menghapus item.");
            }
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-items');
            container.innerHTML = '';

            if (checklistItems.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-2">Tambahkan tugas harian Anda, seperti cek bensin atau ban.</p>';
            } else {
                checklistItems.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = `flex items-center justify-between p-3 bg-white rounded-xl shadow-md mb-3 transition duration-200 ${item.completed ? 'opacity-80' : 'hover:bg-gray-50'}`;
                    
                    const textClass = item.completed ? 'line-through text-gray-500' : 'text-gray-800';

                    listItem.innerHTML = `
                        <div class="flex items-center flex-grow">
                            <input type="checkbox" id="check-${item.id}" ${item.completed ? 'checked' : ''} 
                                onclick="window.toggleChecklistItem('${item.id}', ${item.completed})" 
                                class="w-5 h-5 text-lime-600 bg-gray-100 border-gray-300 rounded focus:ring-lime-500 focus:border-lime-500 transition duration-150 cursor-pointer">
                            <label for="check-${item.id}" class="ml-3 text-base font-medium ${textClass} cursor-pointer">${item.text}</label>
                        </div>
                        <button onclick="window.deleteChecklistItem('${item.id}')" aria-label="Hapus item checklist" class="text-red-400 hover:text-red-600 p-1 rounded-full transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    container.appendChild(listItem);
                });
            }
        }

        // --- GLOBAL WINDOW EXPOSURE (Untuk akses dari HTML inline) ---
        window.addOrder = addOrder;
        window.deleteOrder = deleteOrder;
        window.addExpense = addExpense;
        window.deleteExpense = deleteExpense;
        window.addChecklistItem = addChecklistItem;
        window.toggleChecklistItem = toggleChecklistItem;
        window.deleteChecklistItem = deleteChecklistItem;
        window.updateReportDate = updateReportDate;
        window.renderDailyReportView = renderDailyReportView;
        
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .tab-button {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom: 3px solid #65a30d; /* lime-600 */
            color: #65a30d;
            font-weight: 700;
        }
        
        /* CSS Khusus untuk Pencetakan (Mengganti tampilan web ke laporan) */
        @media print {
            body { 
                background-color: white; 
                padding: 0; 
                margin: 0;
            }
            .no-print, .tab-navigation, #custom-alert-modal, .tab-content.hidden, header, footer { 
                display: none !important; 
            }
            .tab-content {
                display: block !important;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .print-only {
                display: block !important;
            }
            #report-content-container {
                box-shadow: none !important;
                padding: 0 !important;
                /* Memastikan grid detail tampil dalam satu kolom di PDF jika perlu */
                grid-template-columns: 1fr !important;
            }
            h1, h2, h3 { color: #1f2937 !important; }
        }
        .print-only {
            display: none;
        }
    </style>
</head>
<body class="p-4 sm:p-6 pb-20">
    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="hidden opacity-0 fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl transition duration-500 ease-in-out z-50">
        <span id="custom-alert-message"></span>
    </div>
    
    <div class="no-print">
        <div id="status-message" class="text-center text-sm text-gray-500 mb-2">Memuat data dari Cloud...</div>
        <div id="user-id-display" class="text-center text-xs text-gray-400 mb-4 truncate" title="ID unik untuk menyimpan data Anda"></div>

        <header class="mb-6">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-1">Driver Boost</h1>
            <p class="text-gray-500">Optimalkan Order, Minimalisir Pengeluaran!</p>
        </header>
    </div>

    <!-- Tab Navigation -->
    <div class="flex justify-around bg-white p-2 rounded-xl shadow-lg mb-6 sticky top-0 z-10 border-b border-gray-100 overflow-x-auto tab-navigation no-print">
        <button id="tab-zona" class="tab-button active p-3 flex-1 min-w-[80px] text-center text-gray-600" onclick="switchTab('zona')">Zona Ramai</button>
        <button id="tab-log" class="tab-button p-3 flex-1 min-w-[80px] text-center text-gray-600" onclick="switchTab('log')">Log Order</button>
        <button id="tab-pengeluaran" class="tab-button p-3 flex-1 min-w-[80px] text-center text-gray-600" onclick="switchTab('pengeluaran')">Pengeluaran</button>
        <button id="tab-laporan" class="tab-button p-3 flex-1 min-w-[80px] text-center text-gray-600" onclick="switchTab('laporan')">Laporan Harian</button>
        <button id="tab-checklist" class="tab-button p-3 flex-1 min-w-[80px] text-center text-gray-600" onclick="switchTab('checklist')">Checklist</button>
    </div>

    <!-- Tab Content Container -->
    <div id="tab-content">
        
        <!-- Tab 1: Zona Ramai -->
        <div id="content-zona" class="tab-content">
            <h2 class="text-xl font-bold text-gray-800 mb-4 no-print">Pola Permintaan Harian</h2>
            <div id="zone-recommendation" class="mb-6 no-print">
                <!-- Konten rekomendasi akan dimuat di sini -->
            </div>
            <div id="daily-summary" class="bg-lime-600 text-white p-5 rounded-xl shadow-xl mb-6 text-center no-print">
                <!-- Ringkasan Keuntungan Bersih hari ini akan di-render di sini -->
            </div>
        </div>

        <!-- Tab 2: Log Order -->
        <div id="content-log" class="tab-content hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 no-print">Catat Penghasilan Harian</h2>
            
            <!-- Form Tambah Order -->
            <form id="add-order-form" onsubmit="window.addOrder(event)" class="bg-white p-5 rounded-xl shadow-md mb-6 space-y-4 no-print">
                <h3 class="font-semibold text-gray-800">Tambah Order Baru</h3>
                <div>
                    <label for="serviceType" class="block text-sm font-medium text-gray-700 mb-1">Jenis Layanan</label>
                    <select id="serviceType" name="serviceType" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-lime-500 focus:border-lime-500">
                        <option value="GrabBike">GrabBike</option>
                        <option value="GrabFood">GrabFood</option>
                        <option value="GrabExpress">GrabExpress</option>
                        <option value="GrabCar">GrabCar</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div>
                    <label for="earning" class="block text-sm font-medium text-gray-700 mb-1">Pendapatan (Netto, Rp)</label>
                    <input type="number" id="earning" name="earning" required min="1" placeholder="Contoh: 15000" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-lime-500 focus:border-lime-500">
                </div>
                <button type="submit" class="w-full bg-lime-600 text-white p-3 rounded-xl font-bold hover:bg-lime-700 transition duration-200 shadow-lg shadow-lime-300">
                    Catat Order Selesai
                </button>
            </form>
            <!-- Daftar Order -->
            <h3 class="text-lg font-bold text-gray-800 mb-3 no-print">Riwayat Order Hari Ini</h3>
            <div id="orders-list" class="no-print space-y-2">
                <!-- Daftar order akan di-render di sini -->
            </div>
        </div>
        
        <!-- Tab 3: Pengeluaran -->
        <div id="content-pengeluaran" class="tab-content hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 no-print">Catat Pengeluaran Harian</h2>
            <!-- Form Tambah Pengeluaran -->
            <form id="add-expense-form" onsubmit="window.addExpense(event)" class="bg-white p-5 rounded-xl shadow-md mb-6 space-y-4 no-print">
                <h3 class="font-semibold text-gray-800">Tambah Pengeluaran Baru</h3>
                <div>
                    <label for="expenseType" class="block text-sm font-medium text-gray-700 mb-1">Jenis Pengeluaran</label>
                    <select id="expenseType" name="expenseType" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-red-500 focus:border-red-500">
                        <option value="Bensin">Bensin ⛽️</option>
                        <option value="Makan/Minum">Makan/Minum 🍔</option>
                        <option value="Pulsa/Data">Pulsa/Data 📶</option>
                        <option value="Parkir/Tol">Parkir/Tol 🅿️</option>
                        <option value="Perbaikan Motor">Perbaikan Motor 🛠️</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Pengeluaran (Rp)</label>
                    <input type="number" id="amount" name="amount" required min="1" placeholder="Contoh: 35000" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-red-500 focus:border-red-500">
                </div>
                 <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Catatan (Opsional)</label>
                    <input type="text" id="notes" name="notes" placeholder="Misal: Shell V-Power, makan di warteg" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-red-500 focus:border-red-500">
                </div>
                <button type="submit" class="w-full bg-red-600 text-white p-3 rounded-xl font-bold hover:bg-red-700 transition duration-200 shadow-lg shadow-red-300">
                    Catat Pengeluaran
                </button>
            </form>
            <!-- Daftar Pengeluaran -->
            <h3 class="text-lg font-bold text-gray-800 mb-3 no-print">Riwayat Pengeluaran Hari Ini</h3>
            <div id="expenses-list" class="no-print space-y-2">
                <!-- Daftar pengeluaran akan di-render di sini -->
            </div>
        </div>

        
        <!-- Tab 4: Laporan Harian (Dynamic Printable Report) -->
        <div id="content-laporan" class="tab-content hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 no-print">Analisis & Laporan Keuangan Harian</h2>
            
            <!-- Date Picker Section -->
            <div class="bg-white p-5 rounded-xl shadow-md mb-6 date-picker-section no-print">
                <div class="flex flex-col sm:flex-row justify-start items-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <label for="report-date-picker" class="font-bold text-gray-700 text-sm sm:text-base">Pilih Tanggal Laporan:</label>
                    <input type="date" id="report-date-picker" onchange="window.updateReportDate(event)" 
                           class="p-2 border border-gray-300 rounded-xl w-full sm:w-auto focus:ring-lime-500 focus:border-lime-500">
                </div>
            </div>

            <!-- Report Content Container (Content generated by JS) -->
            <div id="report-content-container">
                <!-- Laporan Harian akan di-render di sini -->
            </div>
            
        </div>

        <!-- Tab 5: Checklist -->
        <div id="content-checklist" class="tab-content hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 no-print">Daftar Periksa Kesiapan Harian</h2>

            <!-- Form Tambah Item Checklist -->
            <form id="add-checklist-form" onsubmit="window.addChecklistItem(event)" class="bg-white p-5 rounded-xl shadow-md mb-6 space-y-4 no-print">
                <h3 class="font-semibold text-gray-800">Tambahkan Tugas Baru</h3>
                <div class="flex space-x-2">
                    <input type="text" id="checklistItemText" name="checklistItemText" required placeholder="Contoh: Isi bensin ⛽️ atau Cek oli" class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-lime-500 focus:border-lime-500">
                    <button type="submit" class="p-3 bg-lime-600 text-white rounded-xl hover:bg-lime-700 transition duration-200 shadow-md flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                </div>
            </form>

            <!-- Daftar Checklist -->
            <ul id="checklist-items" class="space-y-3 no-print">
                <!-- Daftar item akan di-render di sini -->
            </ul>
        </div>

    </div>

    <script>
        // Logika Penggantian Tab
        function switchTab(tabId) {
            const contents = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            const targetContent = document.getElementById(`content-${tabId}`);
            const targetButton = document.getElementById(`tab-${tabId}`);

            contents.forEach(content => {
                content.classList.add('hidden');
            });
            buttons.forEach(button => {
                button.classList.remove('active');
            });

            if (targetContent && targetButton) {
                targetContent.classList.remove('hidden');
                targetButton.classList.add('active');
            }
            
            // Panggil render laporan saat tab Laporan Harian dibuka
            if (tabId === 'laporan') {
                if (typeof renderDailyReportView === 'function') {
                    renderDailyReportView(currentReportDate); 
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            switchTab('zona');
            // Menjadikan switchTab global agar bisa diakses dari tombol navigasi
            window.switchTab = switchTab; 
        });
    </script>
</body>
</html>

